<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Cloud ¬∑ UI Template</title>
  <style>
    /* ============================
       Color System (Mint/Green Theme)
       ============================ */
    :root{
      --bg: #f4fbf7;
      --panel: #ffffff;
      --ink: #0f2b1e;
      --ink-dim: #49655a;
      --brand-50: #e8fff4;
      --brand-100:#d2f7e6;
      --brand-200:#b3f0d5;
      --brand-300:#86e4bf;
      --brand-400:#5bd6a8;
      --brand-500:#36c792;
      --brand-600:#26a679;
      --brand-700:#1a825e;
      --ring: rgba(54,199,146,.45);
      --border: #e5efe8;
      --shadow: 0 10px 30px rgba(18, 72, 52, .08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: linear-gradient(180deg, var(--bg), #f8fffb 40%);
    }

    /* ============================
       Layout Architecture
       ============================ */
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 24px 18px;
      background: radial-gradient(120% 120% at 0% 0%, var(--brand-50), #f2fff9 60%);
      border-right: 1px solid var(--border);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-radius: 14px;
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, var(--brand-400), var(--brand-600));
      display: grid; place-items: center; color: white; font-weight: 800;
    }
    .brand h1 { font-size: 16px; margin: 0; }
    .brand span { display:block; font-size: 12px; color: var(--ink-dim); }

    /* Navigation Menu */
    .nav {
      display: grid;
      gap: 6px;
      margin-top: 6px;
    }
    .nav button{
      appearance: none; border: none; background: transparent; color: inherit;
      text-align: left; padding: 12px 12px; border-radius: 12px; font-size: 15px;
      display: flex; align-items: center; gap: 10px; cursor: pointer;
    }
    .nav button:hover{ background: var(--brand-100); }
    .nav button.active{ background: var(--brand-200); outline: 2px solid var(--ring); }

    .nav svg{ width: 18px; height: 18px; }

    .btn{
      display: inline-flex; align-items: center; justify-content: center; gap:8px;
      padding: 10px 12px; border-radius: 10px; border: none; cursor: pointer;
      background: linear-gradient(135deg, var(--brand-500), var(--brand-600)); color: white; font-weight: 600;
      box-shadow: var(--shadow);
    }

    /* Main Content Area */
    .main {
      padding: 14px 32px 36px 32px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 14px;
      min-height: 100vh;
    }

    .main > section.panel {
      grid-row: 2;
      min-height: 100%;
    }

    .toolbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-block: 4px;
      margin-bottom: 4px;
    }
    .title{ font-weight: 800; letter-spacing: .2px; font-size: 18px; }
    .search{ display: flex; gap: 10px; align-items: stretch; }
    .search input{
      min-width: 260px; padding: 10px 12px; border:1px solid var(--border); border-radius: 10px;
    }

    /* Generic Panel Style */
    .panel{
      background: var(--panel); border:1px solid var(--border); border-radius: 18px; padding: 18px; box-shadow: var(--shadow);
    }

    /* ============================
       Galleries (Anime / Movies)
       ============================ */
    .gallery-grid{
      --min: 160px;
      display: grid; gap: 14px; align-content: start;
      grid-template-columns: repeat(auto-fill, minmax(var(--min), 1fr));
    }
    .card{
      border:1px solid var(--border); border-radius: 14px; overflow: hidden; background: #fff; display: grid; grid-template-rows: auto auto;
      transition: transform .15s ease, box-shadow .15s ease;
      cursor: pointer;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }

    /* 16:9 Poster Container */
    .thumb-rect{
      position: relative;
      width: 100%;
      aspect-ratio: 2 / 3;
      overflow: hidden;
      border-radius: 12px;
      background: #f1f6f3;
    }
    .thumb-rect img{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
    }

    .card .meta{
      padding: 10px 12px;
      font-size: 14px;
      line-height: 1.3;
      min-height: calc(1.3em * 2);
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
    }

    /* ============================
       Photos (Square Grid)
       ============================ */
    .square-grid{ --min: 200px; display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(var(--min), 1fr)); }

    .thumb-square{
      aspect-ratio: 1/1; width: 100%; border-radius: 10px; overflow: hidden;
      background: linear-gradient(180deg, var(--brand-100), #eef8f3);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer; /* Changes cursor to pointer on hover */
    }
    .thumb-square img{ position:absolute; inset:0; width:100%; height:100%; object-fit: cover; }

    /* ============================
       File Manager (Explorer-like)
       ============================ */
    .fm-toolbar{ display:flex; align-items:center; gap:10px; margin-bottom: 4px; }
    .fm-path{ flex:1; background:#fff; border:1px solid var(--border); border-radius: 10px; padding:8px 10px; font-size: 14px; color: var(--ink-dim); }
    .fm-actions .btn{ padding: 8px 10px; font-size: 14px; }

    .fm-table{
      border:1px solid var(--border); border-radius: 12px; overflow: hidden; background:#fff;
    }
    .fm-row.header{ background: var(--brand-100); color: var(--ink); font-weight: 700; }
    .fm-row{ display:grid; grid-template-columns: 40px 2fr 1fr 1fr 1fr; align-items:center; gap: 8px; padding: 10px 12px; border-bottom:1px solid var(--border); }
    .fm-row:last-child{ border-bottom: none; }
    .fm-cell{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* File Manager hover & cursor behavior */
    .fm-row .fm-cell{
      cursor: inherit;
      user-select: none;    /* Prevent text selection on double click */
    }

    /* Only directory rows show pointer cursor and hover effect */
    .fm-row[data-is-dir="true"]{
      cursor: pointer;
    }
    .fm-row[data-is-dir="true"]:hover{
      background: var(--brand-50);
    }

    .icon{ width:18px; height:18px; }

    @media (max-width: 980px){
      .app{ grid-template-columns: 80px 1fr; }
      .brand h1, .brand span{ display:none; }
      .nav button span{ display:none; }
      .search input{ min-width: 160px; }
      .fm-row{ grid-template-columns: 40px 2fr 1fr 1fr; }
      .hide-sm{ display:none; }
    }
    #view-files.panel{ padding-top: 10px; margin-top: 0; }
    body[data-view='files'] .main { gap: 6px; }
    body[data-view='files'] .toolbar { margin-bottom: 0; padding-block: 2px; }

    /* ============================
       Context Menu (Right Click)
       ============================ */
    .fm-context-menu{
      position: fixed;          /* Fixed positioning to use screen coordinates */
      z-index: 9999;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.18);
      min-width: 160px;
      padding: 4px 0;
      display: none;            /* Hidden by default */
      font-size: 14px;
    }

    .fm-context-menu.open{
      display: block;
    }

    .fm-context-menu ul{
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .fm-context-menu li{
      padding: 6px 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .fm-context-menu li:hover{
      background: var(--brand-50);
    }

    .fm-context-menu li.disabled{
      color: #94a3b8;
      cursor: default;
    }

    .fm-context-menu li.disabled:hover{
      background: transparent;
    }

    .fm-context-menu li.divider{
      height: 1px;
      margin: 4px 0;
      padding: 0;
      background: var(--border);
      cursor: default;
    }

    /* ============================
       Photo Preview Overlay
       ============================ */
    .photo-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;               /* Hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 999;                /* Above everything */
    }

    .photo-overlay.active{
      display: flex;               /* Centered when active */
    }

    .photo-overlay-content{
      border-radius: 20px;
      background: #000;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      position: relative;
      padding: 0;
      overflow: visible;
    }

    .photo-overlay-content img{
      display: block;
      width: auto;
      height: auto;
      max-width: 90vw;  /* Max width 90% of viewport */
      max-height: 90vh; /* Max height 90% of viewport */
    }

    .photo-overlay-close{
      position: absolute;
      top: 8px;
      right: 8px;
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 14px;
    }

  </style>
</head>

<!-- File Manager Context Menu Structure -->
<div id="fmContextMenu" class="fm-context-menu">
  <ul>
    <li data-action="open">Open</li>
    <li class="divider"></li>
    <li data-action="copy">Copy</li>
    <li data-action="cut">Cut</li>
    <li data-action="paste">Paste</li>
    <li class="divider"></li>
    <li data-action="delete">Delete</li>
  </ul>
</div>

<body>
<div class="app">
  <!-- =============================
       Left Sidebar
       ============================= -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">HCM</div>
      <div>
        <h1>LAN based NAS</h1>
        <span>Team Hachimi</span>
      </div>
    </div>

    <nav class="nav" id="nav">
      <button class="active" data-target="anime">
        <!-- clapper board icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="icon"><path d="M3 8h18v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8Z"/><path d="M3 8l3.6-4H12l-3.6 4"/><path d="M12 4h5.4L14 8"/></svg>
        <span>Episode</span>
      </button>
      <button data-target="movies">
        <!-- film icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="icon"><path d="M3 5h18v14H3z"/><path d="M7 5v14M17 5v14M3 9h4M17 9h4M3 15h4M17 15h4"/></svg>
        <span>Movies</span>
      </button>
      <button data-target="photos">
        <!-- photo icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="icon"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="m8 14 3-3 4 5"/><circle cx="9" cy="10" r="1.5"/></svg>
        <span>Photos</span>
      </button>
      <button data-target="files">
        <!-- folder icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="icon"><path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z"/></svg>
        <span>File Manager</span>
      </button>
    </nav>
  </aside>

  <!-- =============================
       Main Content Area
       ============================= -->
  <main class="main">
    <div class="toolbar">
      <div class="title" id="viewTitle">Anime</div>
      <div class="search">
        <input id="searchBox" placeholder="Search this view‚Ä¶" />
        <button class="btn" id="addBtn">Search</button>
      </div>
    </div>

    <!-- Anime View -->
    <section id="view-anime" class="panel">
      <div class="gallery-grid" id="animeGrid">
      </div>
    </section>

    <!-- Movies View -->
    <section id="view-movies" class="panel" hidden>
      <div class="gallery-grid" id="moviesGrid">
      </div>
    </section>

    <!-- Photos View -->
    <section id="view-photos" class="panel" hidden>
      <div class="square-grid" id="photosGrid">
      </div>
    </section>

    <!-- Photo Preview Overlay -->
    <div id="photoOverlay" class="photo-overlay">
      <div class="photo-overlay-content">
        <button class="photo-overlay-close" aria-label="Close preview">‚úï</button>
        <img id="photoOverlayImg" src="" alt="Preview" />
      </div>
    </div>

    <!-- Files View -->
    <section id="view-files" class="panel" hidden>
      <div class="fm-toolbar">
        <button class="btn btn-back" id="fmBackBtn">‚Üê Back</button>
        <div class="fm-path">
          <span id="fmPath">Media</span>
        </div>
        <div class="fm-actions">
          <button class="btn" id="btnNewFolder">New Folder</button>
          <button class="btn" id="btnUpload">Upload</button>
          <!-- Hidden input for file selection -->
          <input type="file" id="fmUploadInput" multiple style="display:none" />
        </div>
      </div>
      <div class="fm-table" id="fmTable">
        <div class="fm-row header">
          <div class="fm-cell"></div>
          <div class="fm-cell">Name</div>
          <div class="fm-cell">Type</div>
          <div class="fm-cell">Modified</div>
          <div class="fm-cell hide-sm">Size</div>
        </div>

        <!-- Dynamic file rows container -->
        <div id="fileTableBody"></div>
      </div>
    </section>
  </main>
</div>

<input type="file" id="imgPicker" accept="image/*" multiple style="display:none" />

<script>
  // =====================================================
  // Configuration & State Management
  // =====================================================

  // File Manager State
  let currentPath = '.';       // Current relative path to 'my_media_folder'
  let filesLoadedOnce = false; // Optimization to prevent re-fetching root on every tab switch
  let currentFileItems = [];   // Cache of current directory items for client-side search

  // Backend Configuration
  // Automatically determines the host (e.g., localhost or LAN IP like 192.168.x.x)
  const BACKEND_HOST = window.location.hostname;
  const BACKEND_PORT = 8000;

  const API_ROOT  = `http://${BACKEND_HOST}:${BACKEND_PORT}`;
  const API_BASE  = `${API_ROOT}/api/v1`;
  const API_MEDIA = `${API_BASE}/media`;
  const API_FILES = `${API_BASE}/files`;

  // DOM Elements
  const nav = document.getElementById('nav');
  const title = document.getElementById('viewTitle');
  const fmPathEl = document.getElementById('fmPath');

  // View Containers
  const views = {
    anime: document.getElementById('view-anime'),
    movies: document.getElementById('view-movies'),
    photos: document.getElementById('view-photos'),
    files: document.getElementById('view-files')
  };

  // Grids & Overlays
  const photosGrid = document.getElementById('photosGrid');
  const photoOverlay = document.getElementById('photoOverlay');
  const photoOverlayImg = document.getElementById('photoOverlayImg');
  const animeGrid = document.getElementById('animeGrid');
  const moviesGrid = document.getElementById('moviesGrid');

  // File Manager Actions
  const btnNewFolder = document.getElementById('btnNewFolder');
  const btnUpload = document.getElementById('btnUpload');
  const fmUploadInput = document.getElementById('fmUploadInput');

  // Context Menu Elements
  const fmPanel = document.getElementById('view-files');
  const fmTable = document.getElementById('fmTable');
  const fmMenu  = document.getElementById('fmContextMenu');

  // Context Menu State
  let fmContextTarget = null;  // Stores info about the right-clicked item: { type: 'entry' | 'blank', name, isDir, path }
  let fmClipboard = null;      // Stores clipboard info: { mode: 'copy' | 'cut', path, name, isDir }

  // Local placeholder data (used as fallback if API fails)
  let animeSeed = [];
  let movieSeed = [];
  let photoSeed = [];

  // =====================================================
  // Anime Logic
  // =====================================================

  function renderAnime(list) {
    const grid = document.getElementById('animeGrid');
    if (!grid) return;

    const data = list || animeSeed;   // Use filtered list if provided, otherwise full seed

    grid.innerHTML = data.map(item => `
        <article class="card" data-folder="Anime/${item.title}">
          <div class="thumb-rect">
            ${item.poster
            ? `<img src="${item.poster}" alt="${item.title} poster"/>`
            : `<span>16:9 Poster</span>`}
          </div>
          <div class="meta">${item.title}</div>
        </article>
      `).join('');
  }

  // Fetch Anime list from Backend API
  async function loadAnimeFromApi() {
    try {
      const res = await fetch(`${API_MEDIA}/anime`);
      if (!res.ok) {
        throw new Error(`Failed to fetch anime: ${res.status}`);
      }

      const data = await res.json();
      // data structure: [{ title: "Title", poster_url: "/static_media/Anime/Title/poster.jpg" }, ...]

      // Map backend data to frontend structure
      animeSeed = data.map(item => ({
        title: item.title,
        // Append API_ROOT to relative poster path
        poster: `${API_ROOT}${item.poster_url}`,
      }));

      renderAnime();
    } catch (err) {
      console.error(err);
      // Fallback to empty or placeholder data on error
      if (animeSeed.length === 0) {
        animeSeed = [];
      }
      renderAnime();
    }
  }

  // =====================================================
  // Movies Logic
  // =====================================================

  function renderMovies(list) {
    const grid = document.getElementById('moviesGrid');
    if (!grid) return;

    const data = list || movieSeed;

    grid.innerHTML = data.map(item => `
        <article class="card" data-folder="Movies/${item.title}">
          <div class="thumb-rect">
            ${item.poster
            ? `<img src="${item.poster}" alt="${item.title} poster" />`
            : `<span>16:9 Poster</span>`}
          </div>
          <div class="meta">${item.title}</div>
        </article>
      `).join('');
  }

  // Fetch Movies list from Backend API
  async function loadMoviesFromApi() {
    try {
      const res = await fetch(`${API_MEDIA}/movies`);
      if (!res.ok) {
        throw new Error(`Failed to fetch movies: ${res.status}`);
      }

      const data = await res.json();

      movieSeed = data.map(item => ({
        title: item.title,
        poster: `${API_ROOT}${item.poster_url}`,
      }));

      renderMovies();
    } catch (err) {
      console.error(err);
      if (movieSeed.length === 0) {
        movieSeed = [];
      }
      renderMovies();
    }
  }

  // =====================================================
  // Photos Logic
  // =====================================================

  function renderPhotos(list) {
    const grid = document.getElementById('photosGrid');
    if (!grid) return;

    const data = list || photoSeed;

    grid.innerHTML = data.map(item => `
        <div class="thumb-square">
          <img src="${item.src}" alt="${item.title}" />
        </div>
      `).join('');
  }

  async function loadPhotosFromApi() {
    try {
      // Reuse the file browse API, hardcoded to the 'Photos' directory
      const res = await fetch(`${API_FILES}/browse?path=Photos`);
      if (!res.ok) {
        throw new Error(`Failed to browse Photos: ${res.status}`);
      }

      const data = await res.json();
      // data.items contains list of files

      // Filter for valid image extensions
      const imageExts = ['.jpg', '.jpeg', '.png', '.webp', '.gif'];
      const items = (data.items || []).filter(it => {
        if (it.is_dir) return false;
        const lower = it.name.toLowerCase();
        return imageExts.some(ext => lower.endsWith(ext));
      });

      // Map to frontend structure
      photoSeed = items.map(it => ({
        title: it.name,
        // Construct static media URL
        src: `${API_ROOT}/static_media/Photos/${encodeURIComponent(it.name)}`,
      }));

      renderPhotos();
    } catch (err) {
      console.error(err);
      if (photoSeed.length === 0) {
        photoSeed = [];
      }
      renderPhotos();
    }
  }

  // Photo Preview Event Listeners
  if (photosGrid && photoOverlay && photoOverlayImg) {
    // Click on thumbnail -> Open preview
    photosGrid.addEventListener('click', (e) => {
      const cell = e.target.closest('.thumb-square');
      if (!cell) return;

      const img = cell.querySelector('img');
      if (!img) return;

      openPhotoPreview(img.src, img.alt || '');
    });

    // Click overlay background or close button -> Close
    photoOverlay.addEventListener('click', (e) => {
      if (e.target === photoOverlay || e.target.closest('.photo-overlay-close')) {
        photoOverlay.classList.remove('active');
        photoOverlayImg.src = '';
      }
    });

    // ESC key -> Close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && photoOverlay.classList.contains('active')) {
        photoOverlay.classList.remove('active');
        photoOverlayImg.src = '';
      }
    });
  }

  // =====================================================
  // Navigation Handling (Clicking Cards)
  // =====================================================

  if (animeGrid) {
    animeGrid.addEventListener('click', (e) => {
      const card = e.target.closest('.card');
      if (!card) return;
      const folder = card.dataset.folder;  // e.g., "Anime/Frieren"
      if (folder) jumpToFileManager(folder);
    });
  }

  if (moviesGrid) {
    moviesGrid.addEventListener('click', (e) => {
      const card = e.target.closest('.card');
      if (!card) return;
      const folder = card.dataset.folder;  // e.g., "Movies/Inception"
      if (folder) jumpToFileManager(folder);
    });
  }

  // =====================================================
  // Utility Functions
  // =====================================================

  // Format ISO datetime string to readable format (YYYY-MM-DD HH:MM:SS)
  function formatModified(value) {
    if (!value) return '';
    const str = String(value);
    const [datePart, timePartRaw] = str.split('T');
    if (!timePartRaw) return str;
    const timePart = timePartRaw.slice(0, 8); // Extract HH:MM:SS
    return `${datePart} ${timePart}`;
  }

  // Format bytes to readable size (KB, MB, GB)
  function formatSize(bytes, isDir) {
    if (bytes == null) return '‚Äî';
    if (isDir) return '‚Äî'; // Directories don't show size to save performance

    const b = Number(bytes);
    if (!isFinite(b) || b < 0) return '‚Äî';
    if (b === 0) return '0 B';

    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = b;
    let unit = 0;
    while (size >= 1024 && unit < units.length - 1) {
      size /= 1024;
      unit++;
    }

    const fixed = size >= 10 || unit === 0 ? size.toFixed(0) : size.toFixed(1);
    return `${fixed} ${units[unit]}`;
  }

  // Render the File Manager table rows
  function renderFiles(items) {
    const table = document.getElementById('fileTableBody');
    if (!table) return;

    table.innerHTML = '';

    if (!items || items.length === 0) {
      table.innerHTML = `
          <div class="fm-row">
            <div class="fm-cell" colspan="5" style="opacity:0.7">Empty Folder</div>
          </div>
        `;
      return;
    }

    const rowsHtml = items.map(it => {
      const icon = it.is_dir ? 'üìÅ' : 'üìÑ';
      const type = it.is_dir ? 'Folder' : (it.extension || 'File');
      const modified = formatModified(it.modified);
      const size     = formatSize(it.size, it.is_dir);

      return `
          <div class="fm-row"
              data-name="${it.name}"
              data-is-dir="${it.is_dir}">
            <div class="fm-cell">${icon}</div>
            <div class="fm-cell fm-name">${it.name}</div>
            <div class="fm-cell">${type}</div>
            <div class="fm-cell">${modified}</div>
            <div class="fm-cell hide-sm">${size}</div>
          </div>
        `;
    }).join('');

    table.innerHTML = rowsHtml;

    // Update Breadcrumb Path
    if (fmPathEl) {
      const display = currentPath === '.' ? 'Media' : `Media / ${currentPath}`;
      fmPathEl.textContent = display;
    }
  }

  // Handle Double Click on File Rows
  function handleFileTableDblclick(e) {
    const row = e.target.closest('.fm-row');
    if (!row || !row.dataset.name) return;

    const name = row.dataset.name;
    const isDir = row.dataset.isDir === 'true';
    const relPath = currentPath === '.' ? name : `${currentPath}/${name}`;

    if (isDir) {
      // Double click folder -> Enter directory
      loadFilesFromApi(relPath);
    } else {
      // Double click file -> Open (Preview or Download)
      const url = buildStaticMediaUrl(relPath);

      if (isImageFile(name)) {
        openPhotoPreview(url, name);
      } else {
        window.open(url, '_blank');
      }
    }
  }

  function openPhotoPreview(url, altText = '') {
    if (!photoOverlay || !photoOverlayImg) return;
    photoOverlayImg.src = url;
    photoOverlayImg.alt = altText || '';
    photoOverlay.classList.add('active');
  }

  function isImageFile(name) {
    const lower = String(name || '').toLowerCase();
    return ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg']
            .some(ext => lower.endsWith(ext));
  }

  // Convert relative path to static media URL
  function buildStaticMediaUrl(relPath) {
    const safe = (relPath || '')
            .split('/')
            .map(encodeURIComponent)
            .join('/');
    return `${API_ROOT}/static_media/${safe}`;
  }

  // =====================================================
  // Search Logic
  // =====================================================
  const searchBox = document.getElementById('searchBox');
  const searchBtn = document.getElementById('addBtn');

  function applySearch() {
    if (!searchBox) return;
    const raw = searchBox.value || '';
    const q = raw.trim().toLowerCase();
    const view = document.body.dataset.view || 'anime';

    // Empty search -> Reset to full list
    if (!q) {
      if (view === 'anime') renderAnime();
      else if (view === 'movies') renderMovies();
      else if (view === 'photos') renderPhotos();
      else if (view === 'files') renderFiles(currentFileItems);
      return;
    }

    // Filter logic per view
    if (view === 'anime') {
      const filtered = animeSeed.filter(item => item.title.toLowerCase().includes(q));
      renderAnime(filtered);
    } else if (view === 'movies') {
      const filtered = movieSeed.filter(item => item.title.toLowerCase().includes(q));
      renderMovies(filtered);
    } else if (view === 'photos') {
      const filtered = photoSeed.filter(item => item.title.toLowerCase().includes(q));
      renderPhotos(filtered);
    } else if (view === 'files') {
      const filtered = currentFileItems.filter(it => {
        const name = (it.name || '').toLowerCase();
        return name.includes(q);
      });
      renderFiles(filtered);
    }
  }

  if (searchBtn) searchBtn.addEventListener('click', applySearch);
  if (searchBox) {
    searchBox.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') applySearch();
    });
  }

  // =====================================================
  // File Manager Data Fetching
  // =====================================================
  async function loadFilesFromApi(path = '.') {
    try {
      currentPath = path;

      const url = path === '.'
              ? `${API_FILES}/browse`
              : `${API_FILES}/browse?path=${encodeURIComponent(path)}`;

      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Failed to browse files: ${res.status}`);
      }

      const data = await res.json();
      const items = data.items || data.files || [];

      currentFileItems = items;   // Cache for search functionality
      renderFiles(items);
      filesLoadedOnce = true;
    } catch (err) {
      console.error(err);
      alert('Failed to load file list from NAS.');
    }
  }

  function jumpToFileManager(targetPath) {
    // 1. Switch view to File Manager
    const filesBtn = nav.querySelector('button[data-target="files"]');
    if (filesBtn) filesBtn.click();

    // 2. Load the target path
    loadFilesFromApi(targetPath);
  }

  // Handle "Back" button logic
  function goUpOneLevel() {
    if (currentPath === '.') return; // Already at root

    const parts = currentPath.split('/');
    parts.pop();
    const parent = parts.length ? parts.join('/') : '.';

    loadFilesFromApi(parent);
  }

  const fmBackBtn = document.getElementById('fmBackBtn');
  if (fmBackBtn) {
    fmBackBtn.addEventListener('click', () => goUpOneLevel());
  }

  // Handle Single Click navigation in File Manager
  document.addEventListener('click', (event) => {
    const table = document.getElementById('fmTable');
    if (!table || !table.contains(event.target)) return;

    const row = event.target.closest('.fm-row');
    if (!row) return;

    const name = row.dataset.name;
    const isDir = row.dataset.isDir === 'true';

    if (!name || !isDir) return;

    const newPath = currentPath === '.' ? name : `${currentPath}/${name}`;
    loadFilesFromApi(newPath);
  });

  // =====================================================
  // Sidebar Navigation Logic
  // =====================================================
  nav.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-target]');
    if (!btn) return;
    const target = btn.getAttribute('data-target');

    // 1. Toggle active state
    [...nav.querySelectorAll('button')].forEach(b =>
            b.classList.toggle('active', b === btn)
    );

    // 2. Toggle views
    Object.entries(views).forEach(([key, el]) => {
      el.hidden = key !== target;
    });

    // 3. Update dataset state
    document.body.dataset.view = target;

    // 4. Update Title
    const mapping = {
      anime: 'Anime',
      movies: 'Movies',
      photos: 'Photo Library',
      files: 'File Manager'
    };
    title.textContent = mapping[target] || 'Home Cloud';

    // 5. Load files if accessing File Manager for the first time
    if (target === 'files' && !filesLoadedOnce) {
      loadFilesFromApi('.');
      filesLoadedOnce = true;
    }

    // 6. Reset search
    if (searchBox) searchBox.value = '';

    // 7. Refresh data when switching views
    if (target === 'anime') renderAnime();
    if (target === 'movies') renderMovies();
    if (target === 'photos') renderPhotos();
    if (target === 'files' && currentFileItems.length) {
      renderFiles(currentFileItems);
    }
  });

  // =====================================================
  // File Manager Actions (New Folder, Upload)
  // =====================================================

  // New Folder
  if (btnNewFolder) {
    btnNewFolder.addEventListener('click', async () => {
      const name = prompt('Enter new folder name:');
      if (!name) return;

      const folderName = name.trim();
      if (!folderName) return;

      const payload = {
        path: currentPath || '.',
        folder_name: folderName,
      };

      try {
        const res = await fetch(`${API_FILES}/mkdir`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          let errMsg = `Failed to create folder: ${res.status}`;
          try {
            const errJson = await res.json();
            if (errJson.detail) errMsg = errJson.detail;
          } catch (_) {}
          alert(errMsg);
          return;
        }

        // Refresh directory
        await res.json();
        await loadFilesFromApi(currentPath);
      } catch (err) {
        console.error(err);
        alert('Error creating folder.');
      }
    });
  }

  // File Upload
  if (btnUpload && fmUploadInput) {
    btnUpload.addEventListener('click', () => {
      fmUploadInput.value = '';
      fmUploadInput.click();
    });

    fmUploadInput.addEventListener('change', async () => {
      const files = Array.from(fmUploadInput.files || []);
      if (!files.length) return;

      const formData = new FormData();

      // Append files
      for (const file of files) {
        formData.append('files', file);
      }
      // Append path
      formData.append('path', currentPath || '.');

      try {
        const res = await fetch(`${API_FILES}/upload`, {
          method: 'POST',
          body: formData,
        });

        if (!res.ok) {
          let errMsg = `Upload failed: ${res.status}`;
          try {
            const errJson = await res.json();
            if (Array.isArray(errJson.detail)) {
              errMsg = errJson.detail.map(d => `${d.loc?.join('.')}: ${d.msg}`).join('; ');
            } else if (typeof errJson.detail === 'string') {
              errMsg = errJson.detail;
            }
          } catch (_) {}
          alert(errMsg);
        } else {
          await res.json();
        }
      } catch (err) {
        console.error(err);
        alert(`Error during upload.`);
      }

      // Refresh directory after upload
      await loadFilesFromApi(currentPath);
    });
  }

  // =====================================================
  // Initialization
  // =====================================================
  window.addEventListener('DOMContentLoaded', () => {
    loadAnimeFromApi();
    loadMoviesFromApi();
    loadPhotosFromApi();

    const fileTableBody = document.getElementById('fileTableBody');
    if (fileTableBody) {
      fileTableBody.addEventListener('dblclick', handleFileTableDblclick);
    }
  });

  // =====================================================
  // Context Menu Logic
  // =====================================================

  function setMenuItemDisabled(action, disabled) {
    if (!fmMenu) return;
    const li = fmMenu.querySelector(`li[data-action="${action}"]`);
    if (!li) return;
    if (disabled) li.classList.add('disabled');
    else li.classList.remove('disabled');
  }

  function updateContextMenuState() {
    const hasEntry = fmContextTarget && fmContextTarget.type === 'entry';
    const hasClipboard = !!fmClipboard;

    setMenuItemDisabled('open',   !hasEntry);
    setMenuItemDisabled('copy',   !hasEntry);
    setMenuItemDisabled('cut',    !hasEntry);
    setMenuItemDisabled('delete', !hasEntry);
    setMenuItemDisabled('paste',  !hasClipboard);
  }

  function showContextMenu(x, y, targetInfo) {
    if (!fmMenu) return;
    fmContextTarget = targetInfo;
    updateContextMenuState();

    fmMenu.style.display = 'block';
    fmMenu.style.left = x + 'px';
    fmMenu.style.top  = y + 'px';

    // Adjust position if overflowing screen
    const rect = fmMenu.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    if (rect.right > vw) {
      fmMenu.style.left = (vw - rect.width - 8) + 'px';
    }
    if (rect.bottom > vh) {
      fmMenu.style.top = (vh - rect.height - 8) + 'px';
    }
  }

  function hideContextMenu() {
    if (fmMenu) fmMenu.style.display = 'none';
  }

  // Listen for right-click on File Manager
  if (fmPanel) {
    fmPanel.addEventListener('contextmenu', (e) => {
      if (fmMenu && fmMenu.contains(e.target)) return;
      e.preventDefault();

      let targetInfo;
      const isInTable = fmTable && fmTable.contains(e.target);
      const row = isInTable ? e.target.closest('.fm-row') : null;

      if (row && row.dataset.name) {
        const name = row.dataset.name;
        const isDir = row.dataset.isDir === 'true';
        const fullPath = currentPath === '.' ? name : `${currentPath}/${name}`;

        targetInfo = {
          type: 'entry',
          name,
          isDir,
          path: fullPath,
        };
      } else {
        targetInfo = {
          type: 'blank',
          path: currentPath || '.',
        };
      }

      showContextMenu(e.clientX, e.clientY, targetInfo);
    });
  }

  // Close menu interactions
  document.addEventListener('click', (e) => {
    if (!fmMenu) return;
    if (!fmMenu.contains(e.target)) hideContextMenu();
  });
  document.addEventListener('scroll', hideContextMenu, true);
  window.addEventListener('resize', hideContextMenu);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hideContextMenu();
  });

  // Handle Menu Actions
  if (fmMenu) {
    fmMenu.addEventListener('click', async (e) => {
      const li = e.target.closest('li[data-action]');
      if (!li || li.classList.contains('disabled')) return;

      const action = li.dataset.action;
      hideContextMenu();

      switch (action) {
        case 'open':
          await handleFmOpen();
          break;
        case 'copy':
          handleFmCopy(false);
          break;
        case 'cut':
          handleFmCopy(true);
          break;
        case 'paste':
          await handleFmPaste();
          break;
        case 'delete':
          await handleFmDelete();
          break;
      }
    });
  }

  // ========= Action Handlers =========

  // Open: Enter folder or open file
  async function handleFmOpen() {
    if (!fmContextTarget || fmContextTarget.type !== 'entry') return;

    const { name, isDir, path } = fmContextTarget;

    if (isDir) {
      const newPath = currentPath === '.' ? name : `${currentPath}/${name}`;
      await loadFilesFromApi(newPath);
    } else {
      const relPath = path || (currentPath === '.' ? name : `${currentPath}/${name}`);
      const fileUrl = buildStaticMediaUrl(relPath);

      if (isImageFile(name)) {
        openPhotoPreview(fileUrl, name);
      } else {
        window.open(fileUrl, '_blank');
      }
    }
  }

  // Copy / Cut: Set clipboard state
  function handleFmCopy(isCut) {
    if (!fmContextTarget || fmContextTarget.type !== 'entry') return;

    fmClipboard = {
      mode: isCut ? 'cut' : 'copy',
      fromPath: currentPath || '.',
      name: fmContextTarget.name,
      isDir: fmContextTarget.isDir,
    };

    updateContextMenuState();
  }

  // Paste: Call backend /move_copy API
  async function handleFmPaste() {
    if (!fmClipboard) return;

    const payload = {
      src_path: fmClipboard.fromPath,
      dst_path: currentPath || '.',
      name: fmClipboard.name,
      is_dir: fmClipboard.isDir,
      mode: fmClipboard.mode,       // 'copy' or 'cut'
    };

    try {
      const res = await fetch(`${API_FILES}/move_copy`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        let msg = `Paste failed: ${res.status}`;
        try {
          const data = await res.json();
          if (data.detail) msg = data.detail;
        } catch (_) {}
        alert(msg);
        return;
      }

      if (fmClipboard.mode === 'cut') {
        fmClipboard = null; // Clear clipboard after cut
      }

      await loadFilesFromApi(currentPath);
    } catch (err) {
      console.error(err);
      alert('Error during paste operation');
    } finally {
      updateContextMenuState();
    }
  }

  // Delete: Call backend /delete API
  async function handleFmDelete() {
    if (!fmContextTarget || fmContextTarget.type !== 'entry') return;

    const { name, isDir } = fmContextTarget;
    const text = isDir
            ? `Are you sure you want to delete folder "${name}" and all its contents?`
            : `Are you sure you want to delete file "${name}"?`;
    if (!confirm(text)) return;

    const payload = {
      path: currentPath || '.',
      name,
      is_dir: isDir,
    };

    try {
      const res = await fetch(`${API_FILES}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        let msg = `Delete failed: ${res.status}`;
        try {
          const data = await res.json();
          if (data.detail) msg = data.detail;
        } catch (_) {}
        alert(msg);
        return;
      }

      await loadFilesFromApi(currentPath);
    } catch (err) {
      console.error(err);
      alert('Error during delete operation');
    }
  }

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home Cloud Â· UI Template</title>
  <style>
    /* ============================
       Color System (Mint/Green)
       ============================ */
    :root{
      --bg: #f4fbf7;
      --panel: #ffffff;
      --ink: #0f2b1e;
      --ink-dim: #49655a;
      --brand-50: #e8fff4;
      --brand-100:#d2f7e6;
      --brand-200:#b3f0d5;
      --brand-300:#86e4bf;
      --brand-400:#5bd6a8;
      --brand-500:#36c792;
      --brand-600:#26a679;
      --brand-700:#1a825e;       
      --ring: rgba(54,199,146,.45);
      --border: #e5efe8;         
      --shadow: 0 10px 30px rgba(18, 72, 52, .08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: linear-gradient(180deg, var(--bg), #f8fffb 40%);
    }

    /* ============================
       Layout
       ============================ */
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 24px 18px;
      background: radial-gradient(120% 120% at 0% 0%, var(--brand-50), #f2fff9 60%);
      border-right: 1px solid var(--border);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-radius: 14px;
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, var(--brand-400), var(--brand-600));
      display: grid; place-items: center; color: white; font-weight: 800;
    }
    .brand h1 { font-size: 16px; margin: 0; }
    .brand span { display:block; font-size: 12px; color: var(--ink-dim); }

    .nav {
      display: grid;
      gap: 6px;
      margin-top: 6px;
    }
    .nav button{
      appearance: none; border: none; background: transparent; color: inherit;
      text-align: left; padding: 12px 12px; border-radius: 12px; font-size: 15px;
      display: flex; align-items: center; gap: 10px; cursor: pointer;
    }
    .nav button:hover{ background: var(--brand-100); }
    .nav button.active{ background: var(--brand-200); outline: 2px solid var(--ring); }

    .nav svg{ width: 18px; height: 18px; }

    .field{ display: grid; gap: 8px; margin-bottom: 10px; }
    .field label{ font-size: 12px; color: var(--ink-dim); }
    .field input{ padding: 10px 12px; border:1px solid var(--border); border-radius: 10px; outline: none; }
    .field input:focus{ border-color: var(--brand-400); box-shadow: 0 0 0 4px var(--ring); }
    .btn{ 
      display: inline-flex; align-items: center; justify-content: center; gap:8px;
      padding: 10px 12px; border-radius: 10px; border: none; cursor: pointer;
      background: linear-gradient(135deg, var(--brand-500), var(--brand-600)); color: white; font-weight: 600;
      box-shadow: var(--shadow);
    }

    /* Main area */
    .main {
        padding: 14px 32px 36px 32px;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 14px;
        min-height: 100vh;
    }

    .main > section.panel {
        grid-row: 2;
        min-height: 100%;
    }

    .toolbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-block: 4px;
      margin-bottom: 4px;
    }
    .title{ font-weight: 800; letter-spacing: .2px; font-size: 18px; }
    .search{ display: flex; gap: 10px; align-items: stretch; }
    .search input{
      min-width: 260px; padding: 10px 12px; border:1px solid var(--border); border-radius: 10px;
    }

    /* Panels */
    .panel{
      background: var(--panel); border:1px solid var(--border); border-radius: 18px; padding: 18px; box-shadow: var(--shadow);
    }

    /* ============================
       Galleries (Anime / Movies)
       ============================ */
    .gallery-grid{
      --min: 160px;
      display: grid; gap: 14px; align-content: start;
      grid-template-columns: repeat(auto-fill, minmax(var(--min), 1fr));
    }
    .card{
      border:1px solid var(--border); border-radius: 14px; overflow: hidden; background: #fff; display: grid; grid-template-rows: auto auto;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }

    /* 16:9 poster (rectangular) */
    .thumb-rect{
    position: relative;
    width: 100%;
    aspect-ratio: 2 / 3;
    overflow: hidden;
    border-radius: 12px;
    background: #f1f6f3;
    }
    .thumb-rect img{
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    object-position: center;
    }

    .card .meta{
    padding: 10px 12px;
    font-size: 14px;
    line-height: 1.3;
    min-height: calc(1.3em * 2);
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
    }

    /* ============================
       Photos (Square Grid)
       ============================ */
    .square-grid{ --min: 200px; display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(var(--min), 1fr)); }
    .thumb-square{ aspect-ratio: 1/1; width: 100%; border-radius: 10px; overflow: hidden; background: linear-gradient(180deg, var(--brand-100), #eef8f3); position: relative; }
    .thumb-square img{ position:absolute; inset:0; width:100%; height:100%; object-fit: cover; }

    .square-grid .thumb-square{
    background: #e2f3ea;
    border-radius: 18px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;   /* â­ è®©é¼ æ ‡å˜å°æ‰‹ */
  }

    /* ============================
       File Manager (Explorer-like)
       ============================ */
    .fm-toolbar{ display:flex; align-items:center; gap:10px; margin-bottom: 4px; }
    .fm-path{ flex:1; background:#fff; border:1px solid var(--border); border-radius: 10px; padding:8px 10px; font-size: 14px; color: var(--ink-dim); }
    .fm-actions .btn{ padding: 8px 10px; font-size: 14px; }

    .fm-table{
      border:1px solid var(--border); border-radius: 12px; overflow: hidden; background:#fff;
    }
    .fm-row.header{ background: var(--brand-100); color: var(--ink); font-weight: 700; }
    .fm-row{ display:grid; grid-template-columns: 40px 2fr 1fr 1fr 1fr; align-items:center; gap: 8px; padding: 10px 12px; border-bottom:1px solid var(--border); }
    .fm-row:last-child{ border-bottom: none; }
    .fm-cell{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    /* File Manager hover & cursor */
    .fm-row .fm-cell{
      cursor: inherit;      /* å­å…ƒç´ è·Ÿéšæ•´è¡Œçš„é¼ æ ‡æ ·å¼ */
      user-select: none;    /* é˜²æ­¢å˜æˆæ–‡å­—é€‰ä¸­å…‰æ ‡ */
    }

    /* åªæœ‰å¯ç‚¹å‡»çš„â€œæ–‡ä»¶å¤¹è¡Œâ€å˜å°æ‰‹ + å˜è‰² */
    .fm-row[data-is-dir="true"]{
      cursor: pointer;
    }
    .fm-row[data-is-dir="true"]:hover{
      background: var(--brand-50);
    }

    .icon{ width:18px; height:18px; }

    @media (max-width: 980px){
      .app{ grid-template-columns: 80px 1fr; }
      .brand h1, .brand span{ display:none; }
      .nav button span{ display:none; }
      .search input{ min-width: 160px; }
      .fm-row{ grid-template-columns: 40px 2fr 1fr 1fr; }
      .hide-sm{ display:none; }
    }
    #view-files.panel{ padding-top: 10px; margin-top: 0; }
    body[data-view='files'] .main { gap: 6px; }
    body[data-view='files'] .toolbar { margin-bottom: 0; padding-block: 2px; }
        /* ---------- File Manager å³é”®èœå• ---------- */
    /* å³é”®èœå• */
    .fm-context-menu{
      position: fixed;          /* å¿…é¡»æ˜¯ fixedï¼Œæ‰èƒ½ç”¨å±å¹•åæ ‡ */
      z-index: 9999;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.18);
      min-width: 160px;
      padding: 4px 0;
      display: none;            /* åˆå§‹ä¸æ˜¾ç¤º */
      font-size: 14px;
    }

    .fm-context-menu.open{
      display: block;
    }

    .fm-context-menu ul{
      list-style: none;         /* å»æ‰ä½ æˆªå›¾é‡Œçš„å°åœ†ç‚¹ */
      margin: 0;
      padding: 0;
    }

    .fm-context-menu li{
      padding: 6px 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .fm-context-menu li:hover{
      background: var(--brand-50);
    }

    .fm-context-menu li.disabled{
      color: #94a3b8;
      cursor: default;
    }

    .fm-context-menu li.disabled:hover{
      background: transparent;
    }

    .fm-context-menu li.divider{
      height: 1px;
      margin: 4px 0;
      padding: 0;
      background: var(--border);
      cursor: default;
    }

    /* ============================
   Photo Preview Overlay
   ============================ */
    .photo-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;               /* é»˜è®¤éšè— */
      align-items: center;
      justify-content: center;
      z-index: 999;                /* å‹è¿‡å…¶ä»–å†…å®¹ */
    }

    .photo-overlay.active{
      display: flex;               /* æ˜¾ç¤ºæ—¶ç”¨ flex å±…ä¸­ */
    }

    .photo-overlay-content{
      /* åªè´Ÿè´£åŒ…ä¸€å±‚å£³ï¼Œä¸å¼ºè¡Œé™åˆ¶å®½é«˜æ¯”ä¾‹ */
      border-radius: 20px;
      background: #000;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      position: relative;
      padding: 0;
      /* ä¸å†ç”¨ max-width / max-height å»å‹ç¼©å®¹å™¨æœ¬èº« */
      overflow: visible;
    }

    .photo-overlay-content img{
      display: block;
      /* æŒ‰åŸå§‹æ¯”ä¾‹æ¸²æŸ“ */
      width: auto;
      height: auto;
      /* ä½†æ˜¯æœ€å¤§ä¸èƒ½è¶…è¿‡è§†å£å¤§å° */
      max-width: 90vw;
      max-height: 90vh;
      /* ä¸éœ€è¦å† object-fit äº†ï¼ŒæŒ‰è‡ªç„¶æ¯”ä¾‹å³å¯ */
    }


    .photo-overlay-close{
      position: absolute;
      top: 8px;
      right: 8px;
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 14px;
    }

  </style>
</head>

<!-- File Manager å³é”®èœå• -->
<div id="fmContextMenu" class="fm-context-menu">
  <ul>
    <li data-action="open">Open</li>
    <li class="divider"></li>
    <li data-action="copy">Copy</li>
    <li data-action="cut">Cut</li>
    <li data-action="paste">Paste</li>
    <li class="divider"></li>
    <li data-action="delete">Delete</li>
  </ul>
</div>

<body>
  <div class="app">
    <!-- =============================
         Left Sidebar
         ============================= -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">HCM</div>
        <div>
          <h1>LAN based NAS
          </h1>
          <span>Team Hachimi</span>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="active" data-target="anime">
          <!-- clapper board icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="icon"><path d="M3 8h18v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8Z"/><path d="M3 8l3.6-4H12l-3.6 4"/><path d="M12 4h5.4L14 8"/></svg>
          <span>Anime</span>
        </button>
        <button data-target="movies">
          <!-- film icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="icon"><path d="M3 5h18v14H3z"/><path d="M7 5v14M17 5v14M3 9h4M17 9h4M3 15h4M17 15h4"/></svg>
          <span>Movies</span>
        </button>
        <button data-target="photos">
          <!-- photo icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="icon"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="m8 14 3-3 4 5"/><circle cx="9" cy="10" r="1.5"/></svg>
          <span>Photos</span>
        </button>
        <button data-target="files">
          <!-- folder icon -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" class="icon"><path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z"/></svg>
          <span>File Manager</span>
        </button>
      </nav>
    </aside>

    <!-- =============================
         Main Content Area
         ============================= -->
    <main class="main">
      <div class="toolbar">
        <div class="title" id="viewTitle">Anime</div>
        <div class="search">
          <input id="searchBox" placeholder="Search this viewâ€¦" />
          <button class="btn" id="addBtn">Search</button>
        </div>
      </div>

      <!-- Anime View (rectangular posters with name below) -->
      <section id="view-anime" class="panel">
        <div class="gallery-grid" id="animeGrid">
        </div>
      </section>

      <!-- Movies View (like Anime) -->
      <section id="view-movies" class="panel" hidden>
        <div class="gallery-grid" id="moviesGrid">
        </div>
      </section>

      <!-- Photos View (square thumbnails, no names) -->
      <section id="view-photos" class="panel" hidden>
        <div class="square-grid" id="photosGrid">
        </div>
      </section>

      <!-- Photo Preview Overlay -->
      <div id="photoOverlay" class="photo-overlay">
        <div class="photo-overlay-content">
          <button class="photo-overlay-close" aria-label="Close preview">âœ•</button>
          <img id="photoOverlayImg" src="" alt="Preview" />
        </div>
      </div>

      <!-- Files View (Explorer-like) -->
      <section id="view-files" class="panel" hidden>
        <div class="fm-toolbar">
          <button class="btn btn-back" id="fmBackBtn">â† Back</button>
          <div class="fm-path">
            <span id="fmPath">Media</span>
          </div>
          <div class="fm-actions">
            <button class="btn" id="btnNewFolder">New Folder</button>
            <button class="btn" id="btnUpload">Upload</button>
            <input type="file" id="fmUploadInput" multiple style="display:none" />
          </div>
        </div>
        <div class="fm-table" id="fmTable">
          <div class="fm-row header">
            <div class="fm-cell"></div>
            <div class="fm-cell">Name</div>
            <div class="fm-cell">Type</div>
            <div class="fm-cell">Modified</div>
            <div class="fm-cell hide-sm">Size</div>
          </div>

          <!-- è¿™ä¸€è¡Œæ˜¯å…³é”®ï¼Œæ–°åŠ çš„å®¹å™¨ -->
          <div id="fileTableBody"></div>
        </div>
      </section>
    </main>  </div>  <input type="file" id="imgPicker" accept="image/*" multiple style="display:none" />  <script>
    // =====================================================
    // Minimal JS for view switching + sample placeholders
    // =====================================================
    // ============= File Manager çŠ¶æ€ =============
    let currentPath = '.';       // å½“å‰æµè§ˆçš„è·¯å¾„ï¼Œç›¸å¯¹ my_media_folder
    let filesLoadedOnce = false; // æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼ˆé¿å…æ¯æ¬¡åˆ‡æ¢éƒ½é‡æ–°æ‹‰ï¼‰
    let currentFileItems = [];   // â­ å½“å‰ç›®å½•çš„å®Œæ•´æ–‡ä»¶åˆ—è¡¨ï¼Œç”¨äºæœç´¢è¿‡æ»¤
    const fmPathEl = document.getElementById('fmPath');
    
    
    //åç«¯åœ°å€ï¼ˆå¼€å‘é˜¶æ®µï¼‰
    const API_BASE = 'http://localhost:8000/api/v1';
    const API_MEDIA = `${API_BASE}/media`;
    const API_FILES = `${API_BASE}/files`;

    // åç«¯æ ¹åœ°å€ï¼Œç”¨æ¥æ‹¼å›¾ç‰‡ URL
    const API_ROOT = 'http://localhost:8000';
    const nav = document.getElementById('nav');
    const title = document.getElementById('viewTitle');

    // Photos é¢„è§ˆç›¸å…³ DOM
    const photosGrid = document.getElementById('photosGrid');
    const photoOverlay = document.getElementById('photoOverlay');
    const photoOverlayImg = document.getElementById('photoOverlayImg');
    const photoOverlayClose = document.querySelector('.photo-overlay-close');

    const animeGrid = document.getElementById('animeGrid');    // â­ æ–°å¢
    const moviesGrid = document.getElementById('moviesGrid');  // â­ æ–°å¢

    const btnNewFolder = document.getElementById('btnNewFolder');
    const btnUpload = document.getElementById('btnUpload');
    const fmUploadInput = document.getElementById('fmUploadInput');

    // å³é”®ç›¸å…³
    const fmPanel = document.getElementById('view-files');   // æ•´ä¸ª File Manager é¢æ¿
    const fmTable = document.getElementById('fmTable');
    const fmMenu  = document.getElementById('fmContextMenu');

    // å½“å‰å³é”®ç›®æ ‡ & å‰ªåˆ‡æ¿
    let fmContextTarget = null;  // { type: 'entry' | 'blank', name, isDir, path }
    let fmClipboard = null;      // { mode: 'copy' | 'cut', path, name, isDir }

    const views = {
      anime: document.getElementById('view-anime'),
      movies: document.getElementById('view-movies'),
      photos: document.getElementById('view-photos'),
      files: document.getElementById('view-files')
    };

    // -----------------------------------------------------
    // Placeholder content so the layout is visible now
    // You can replace these arrays with scraped data later.
    // -----------------------------------------------------
    let animeSeed = [
      
    ];

    let movieSeed = [

    ];

    // ================ Photos ================
    let photoSeed = [];

    function renderAnime(list) {
      const grid = document.getElementById('animeGrid');
      if (!grid) return;

      const data = list || animeSeed;   // â­ æ²¡ä¼ å°±ç”¨å…¨é‡ animeSeed

      grid.innerHTML = data.map(item => `
        <article class="card" data-folder="Anime/${item.title}">
          <div class="thumb-rect">
            ${item.poster
              ? `<img src="${item.poster}" alt="${item.title} poster"/>`
              : `<span>16:9 Poster</span>`}
          </div>
          <div class="meta">${item.title}</div>
        </article>
      `).join('');
    }
        // ä» NAS åç«¯åŠ è½½ Anime åˆ—è¡¨
    async function loadAnimeFromApi() {
      try {
        const res = await fetch(`${API_MEDIA}/anime`);
        if (!res.ok) {
          throw new Error(`Failed to fetch anime: ${res.status}`);
        }

        const data = await res.json(); 
        // data æ˜¯åç«¯è¿”å›çš„ MediaItem[]ï¼Œç»“æ„ç±»ä¼¼ï¼š
        // [{ title: "åœ°ç¼šå°‘å¹´èŠ±å­å›", poster_url: "/static_media/Anime/åœ°ç¼šå°‘å¹´èŠ±å­å›/poster.jpg" }, ...]

        // æ˜ å°„æˆå‰ç«¯å†…éƒ¨ä½¿ç”¨çš„ç»“æ„
        animeSeed = data.map(item => ({
          title: item.title,
          // poster_url æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè¿™é‡Œæ‹¼æˆå®Œæ•´ URL
          poster: `${API_ROOT}${item.poster_url}`,
        }));

        renderAnime();
      } catch (err) {
        console.error(err);
        alert('ä» NAS åŠ è½½ Anime å¤±è´¥ï¼Œå…ˆç”¨æœ¬åœ°å‡æ•°æ®å±•ç¤º');

        // å¦‚æœä½ æƒ³åœ¨å¤±è´¥æ—¶é€€å›ä»¥å‰çš„é™æ€å‡æ•°æ®ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰‹åŠ¨å¡«å›ä¸€ä»½ï¼š
        if (animeSeed.length === 0) {
          animeSeed = [
            { title: 'SPYÃ—FAMILY Season 3', poster: 'Anime/SPYÃ—FAMILY Season 3.webp' },
            // ... ä½ åŸæ¥çš„é‚£å †å ä½æ•°æ®ï¼Œçˆ±ä¸çˆ±éƒ½è¡Œ
          ];
        }
        renderAnime();
      }
    }

    function renderMovies(list) {
      const grid = document.getElementById('moviesGrid'); // æ³¨æ„æ˜¯ moviesGrid
      if (!grid) return;

      const data = list || movieSeed;

      grid.innerHTML = data.map(item => `
        <article class="card" data-folder="Movies/${item.title}">
          <div class="thumb-rect">
            ${item.poster
              ? `<img src="${item.poster}" alt="${item.title} poster" />`
              : `<span>16:9 Poster</span>`}
          </div>
          <div class="meta">${item.title}</div>
        </article>
      `).join('');
    }

    // ä» NAS åç«¯åŠ è½½ Movies åˆ—è¡¨
    async function loadMoviesFromApi() {
      try {
        const res = await fetch(`${API_MEDIA}/movies`);
        if (!res.ok) {
          throw new Error(`Failed to fetch movies: ${res.status}`);
        }

        const data = await res.json(); // åç«¯è¿”å›çš„ MediaItem[]

        movieSeed = data.map(item => ({
          title: item.title,
          // æŠŠ /static_media/... æ‹¼æˆå®Œæ•´ URL
          poster: `${API_ROOT}${item.poster_url}`,
        }));

        renderMovies();
      } catch (err) {
        console.error(err);
        alert('ä» NAS åŠ è½½ Movies å¤±è´¥ï¼Œæš‚æ—¶ç”¨æœ¬åœ°å ä½æ•°æ®');

        if (movieSeed.length === 0) {
          movieSeed = [
            { title: 'The Godfather', poster: 'Movie/The Godfather.webp' },
            { title: '12.12 THE DAY', poster: 'Movie/12.12THE DAY.jpg' },
          ];
        }
        renderMovies();
      }
    }

    function renderPhotos(list) {
      const grid = document.getElementById('photosGrid');
      if (!grid) return;

      const data = list || photoSeed;   // â­ æœ‰è¿‡æ»¤ç»“æœå°±ç”¨è¿‡æ»¤ç»“æœï¼Œæ²¡æœ‰å°±ç”¨å…¨é‡

    grid.innerHTML = data.map(item => `
      <div class="thumb-square">
        <img src="${item.src}" alt="${item.title}" />
      </div>
    `).join('');
    }


    async function loadPhotosFromApi() {
      try {
        // è°ƒç”¨æ–‡ä»¶æµè§ˆæ¥å£ï¼Œå›ºå®šæµè§ˆ Photos ç›®å½•
        const res = await fetch(`${API_FILES}/browse?path=Photos`);
        if (!res.ok) {
          throw new Error(`Failed to browse Photos: ${res.status}`);
        }

        const data = await res.json();
        // data.items æ˜¯æ–‡ä»¶åˆ—è¡¨

        // åªä¿ç•™æ–‡ä»¶ï¼ˆä¸æ˜¯æ–‡ä»¶å¤¹ï¼‰å¹¶ä¸”æ‰©å±•åæ˜¯å›¾ç‰‡
        const imageExts = ['.jpg', '.jpeg', '.png', '.webp', '.gif'];
        const items = (data.items || []).filter(it => {
          if (it.is_dir) return false;
          const lower = it.name.toLowerCase();
          return imageExts.some(ext => lower.endsWith(ext));
        });

        // æ˜ å°„æˆå‰ç«¯å†…éƒ¨ä½¿ç”¨çš„ç»“æ„
        photoSeed = items.map(it => ({
          title: it.name,
          // æ‹¼æˆ static_media çš„ URLï¼š
          // /static_media/Photos/<æ–‡ä»¶å>
          src: `${API_ROOT}/static_media/Photos/${encodeURIComponent(it.name)}`,
        }));

        renderPhotos();
        } catch (err) {
          console.error(err);
          alert('ä» NAS åŠ è½½ Photos å¤±è´¥ï¼Œæš‚æ—¶ç”¨æœ¬åœ°å ä½å›¾ç‰‡');

          if (photoSeed.length === 0) {
            photoSeed = [
              { title: 'Local Photo 1', src: 'Photo/test photo (1).jpg' },
              { title: 'Local Photo 2', src: 'Photo/test photo (2).jpg' },
            ];
          }
          renderPhotos();
        }
      }

      // ============================
      // Photos é¢„è§ˆé€»è¾‘
      // ============================
      if (photosGrid && photoOverlay && photoOverlayImg) {
        // ç‚¹å‡»ç¼©ç•¥å›¾ -> æ‰“å¼€é¢„è§ˆ
        photosGrid.addEventListener('click', (e) => {
          // å…ˆæ‰¾åˆ°å¤–å±‚æ–¹å—
          const cell = e.target.closest('.thumb-square');
          if (!cell) return;

          // å†ä»é‡Œé¢å–å›¾ç‰‡
          const img = cell.querySelector('img');
          if (!img) return;

          openPhotoPreview(img.src, img.alt || '');
        });

        // ç‚¹å‡»é®ç½©ç©ºç™½åŒºåŸŸå…³é—­
        photoOverlay.addEventListener('click', (e) => {
          if (e.target === photoOverlay || e.target.closest('.photo-overlay-close')) {
            photoOverlay.classList.remove('active');
            photoOverlayImg.src = '';
          }
        });

        // ESC é”®å…³é—­
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && photoOverlay.classList.contains('active')) {
            photoOverlay.classList.remove('active');
            photoOverlayImg.src = '';
          }
        });
      }

    // ============================
    // Anime / Movies ç‚¹å‡» -> è·³åˆ°å¯¹åº”æ–‡ä»¶å¤¹
    // ============================
    if (animeGrid) {
      animeGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.card');
        if (!card) return;

        const folder = card.dataset.folder;  // æ¯”å¦‚ "Anime/Frieren"
        if (!folder) return;

        jumpToFileManager(folder);
      });
    }

    if (moviesGrid) {
      moviesGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.card');
        if (!card) return;

        const folder = card.dataset.folder;  // æ¯”å¦‚ "Movies/Inception"
        if (!folder) return;

        jumpToFileManager(folder);
      });
    }


    // æŠŠåç«¯è¿”å›çš„æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸€ä¸‹ï¼Œåªä¿ç•™åˆ°ç§’
    function formatModified(value) {
      if (!value) return '';

      // FastAPI é»˜è®¤æ˜¯ "2025-11-18T15:06:13.604660" è¿™ç§
      const str = String(value);
      const [datePart, timePartRaw] = str.split('T');
      if (!timePartRaw) return str;

      const timePart = timePartRaw.slice(0, 8); // HH:MM:SS

      // å¦‚æœä½ çœŸçš„åªæƒ³æ˜¾ç¤ºæ—¶é—´ï¼Œå¯ä»¥ return timePart;
      // ç°åœ¨æˆ‘ç»™ä½ æ—¥æœŸ + æ—¶é—´ï¼Œçœ‹èµ·æ¥æ›´æ­£å¸¸ï¼š
      return `${datePart} ${timePart}`;
    }

    // æŠŠå­—èŠ‚æ•°æ ¼å¼åŒ–æˆäººç±»å¯è¯»çš„å½¢å¼
    function formatSize(bytes, isDir) {
      if (bytes == null) return 'â€”';

      // æ–‡ä»¶å¤¹è¿™ä¸€æ­¥å¦‚æœè¦ç®—æ€»å¤§å°å°±å¾—åç«¯é€’å½’ï¼Œéå¸¸åƒæ€§èƒ½ï¼Œ
      // å…ˆç»Ÿä¸€æ˜¾ç¤º "â€”"ï¼Œæ–‡ä»¶æ˜¾ç¤ºçœŸå®å¤§å°
      if (isDir) return 'â€”';

      const b = Number(bytes);
      if (!isFinite(b) || b < 0) return 'â€”';
      if (b === 0) return '0 B';

      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let size = b;
      let unit = 0;
      while (size >= 1024 && unit < units.length - 1) {
        size /= 1024;
        unit++;
      }

      // å°äº 10 çš„ä¿ç•™ 1 ä½å°æ•°ï¼Œå¤§äº 10 å–æ•´
      const fixed = size >= 10 || unit === 0 ? size.toFixed(0) : size.toFixed(1);
      return `${fixed} ${units[unit]}`;
    }
    
    function renderFiles(items) {
      const table = document.getElementById('fileTableBody');
      if (!table) return;

      table.innerHTML = '';

      if (!items || items.length === 0) {
        table.innerHTML = `
          <div class="fm-row">
            <div class="fm-cell" colspan="5" style="opacity:0.7">MT</div>
          </div>
        `;
        return;
      }

      const fileTableBody = document.getElementById('fileTableBody');
      if (fileTableBody) {
        fileTableBody.addEventListener('dblclick', (e) => {
          const row = e.target.closest('.fm-row');
          if (!row || !row.dataset.name) return;

          const name = row.dataset.name;
          const isDir = row.dataset.isDir === 'true';
          const relPath = currentPath === '.' ? name : `${currentPath}/${name}`;

          if (isDir) {
            // åŒå‡»æ–‡ä»¶å¤¹ = è¿›å…¥
            loadFilesFromApi(relPath);
          } else {
            // åŒå‡»æ–‡ä»¶ = æ‰“å¼€ï¼ˆå›¾ç‰‡èµ°é¢„è§ˆï¼Œå…¶å®ƒæ–°æ ‡ç­¾ï¼‰
            const url = buildStaticMediaUrl(relPath);

            if (isImageFile(name)) {
              openPhotoPreview(url, name);
            } else {
              window.open(url, '_blank');
            }
          }
        });
      }

      function openPhotoPreview(url, altText = '') {
        if (!photoOverlay || !photoOverlayImg) return;
        photoOverlayImg.src = url;
        photoOverlayImg.alt = altText || '';
        photoOverlay.classList.add('active');
      }


      const rowsHtml = items.map(it => {
        const icon = it.is_dir ? 'ğŸ“' : 'ğŸ“„';
        const type = it.is_dir ? 'Folder' : (it.extension || 'File');

        const modified = formatModified(it.modified);
        const size     = formatSize(it.size, it.is_dir);

        return `
          <div class="fm-row" 
              data-name="${it.name}" 
              data-is-dir="${it.is_dir}">
            <div class="fm-cell">${icon}</div>
            <div class="fm-cell fm-name">${it.name}</div>
            <div class="fm-cell">${type}</div>
            <div class="fm-cell">${modified}</div>
            <div class="fm-cell hide-sm">${size}</div>
          </div>
        `;
      }).join('');

      table.innerHTML = rowsHtml;

      // æ›´æ–°ä¸Šé¢çš„è·¯å¾„æ˜¾ç¤º
      if (fmPathEl) {
        const display = currentPath === '.' ? 'Media' : `Media / ${currentPath}`;
        fmPathEl.textContent = display;
      }
    }

    function isImageFile(name) {
      const lower = String(name || '').toLowerCase();
      return ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg']
        .some(ext => lower.endsWith(ext));
    }

    function buildStaticMediaUrl(relPath) {
      const safe = String(relPath || '')
        .split('/')
        .map(encodeURIComponent)
        .join('/');
      return `${API_ROOT}/static_media/${safe}`;
    }

    // æŠŠç›¸å¯¹è·¯å¾„å˜æˆ /static_media çš„ URL
    function buildStaticMediaUrl(relPath) {
      // relPath ä¾‹å¦‚: "Anime/Frieren/xxx.mkv" æˆ– "test.txt"
      const safe = (relPath || '')
        .split('/')
        .map(encodeURIComponent)   // æ¯ä¸€æ®µåˆ†åˆ«ç¼–ç ï¼Œé˜²æ­¢ç©ºæ ¼/ä¸­æ–‡ç‚¸æ‰
        .join('/');

      return `${API_ROOT}/static_media/${safe}`;
    }


    const searchBox = document.getElementById('searchBox');
    const searchBtn = document.getElementById('addBtn');

    function applySearch() {
      if (!searchBox) return;
      const raw = searchBox.value || '';
      const q = raw.trim().toLowerCase();

      // å½“å‰è§†å›¾ï¼šanime / movies / photos / files
      const view = document.body.dataset.view || 'anime';

      // å¦‚æœæœç´¢æ¡†æ˜¯ç©ºçš„ -> æ¢å¤åŸå§‹è§†å›¾
      if (!q) {
        if (view === 'anime') {
          renderAnime();                 // ç”¨ animeSeed
        } else if (view === 'movies') {
          renderMovies();
        } else if (view === 'photos') {
          renderPhotos();
        } else if (view === 'files') {
          renderFiles(currentFileItems); // ç”¨å®Œæ•´æ–‡ä»¶åˆ—è¡¨
        }
        return;
      }

      // å„ä¸ªè§†å›¾çš„è¿‡æ»¤é€»è¾‘ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
      if (view === 'anime') {
        const filtered = animeSeed.filter(item =>
          item.title.toLowerCase().includes(q)
        );
        renderAnime(filtered);
      } else if (view === 'movies') {
        const filtered = movieSeed.filter(item =>
          item.title.toLowerCase().includes(q)
        );
        renderMovies(filtered);
      } else if (view === 'photos') {
        const filtered = photoSeed.filter(item =>
          item.title.toLowerCase().includes(q)
        );
        renderPhotos(filtered);
      } else if (view === 'files') {
        const filtered = currentFileItems.filter(it => {
          const name = (it.name || '').toLowerCase();
          const type = it.is_dir
            ? 'folder'
            : (it.extension || '').toLowerCase();

          // ä½ ä¹Ÿå¯ä»¥åªæŒ‰ name è¿‡æ»¤ï¼Œè¿™é‡Œé¡ºä¾¿æŠŠç±»å‹ä¹Ÿç®—ä¸Š
          return name.includes(q) || type.includes(q);
        });
        renderFiles(filtered);
      }
    }

    // ç»‘å®šæœç´¢æŒ‰é’®å’Œå›è½¦é”®
    if (searchBtn) {
      searchBtn.addEventListener('click', applySearch);
    }
    if (searchBox) {
      searchBox.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') applySearch();
      });
    }

    async function loadFilesFromApi(path = '.') {
      try {
        currentPath = path;

        const url = path === '.' 
          ? `${API_FILES}/browse`
          : `${API_FILES}/browse?path=${encodeURIComponent(path)}`;

        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`Failed to browse files: ${res.status}`);
        }

        const data = await res.json();
        const items = data.items || data.files || [];

        currentFileItems = items;   // â­ å­˜ä¸€ä»½å½“å‰ç›®å½•å®Œæ•´åˆ—è¡¨
        renderFiles(items);
        filesLoadedOnce = true;
      } catch (err) {
        console.error(err);
        alert('ä» NAS åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
      }
    }

    function jumpToFileManager(targetPath) {
      // 1. å…ˆåˆ‡åˆ° File Manager è§†å›¾ï¼ˆå¤ç”¨å·¦ä¾§å¯¼èˆªçš„é€»è¾‘ï¼‰
      const filesBtn = nav.querySelector('button[data-target="files"]');
      if (filesBtn) {
        filesBtn.click();   // è¿™ä¼šè§¦å‘åŸæœ¬çš„è§†å›¾åˆ‡æ¢é€»è¾‘
      }

      // 2. ç„¶ååŠ è½½ç›®æ ‡è·¯å¾„
      //    nav çš„ç‚¹å‡»é‡Œä¼šåœ¨ç¬¬ä¸€æ¬¡è¿›å…¥ File Manager æ—¶è‡ªåŠ¨åŠ è½½ä¸€æ¬¡æ ¹ç›®å½•ï¼Œ
      //    è¿™é‡Œå†åŠ è½½æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„ç›®å½•å³å¯ã€‚
      loadFilesFromApi(targetPath);
    }


    // å›é€€åˆ°ä¸Šä¸€çº§ç›®å½•
    function goUpOneLevel() {
      if (currentPath === '.') {
        // å·²ç»åœ¨æ ¹ç›®å½•äº†ï¼Œä¸èƒ½å†é€€
        return;
      }

      const parts = currentPath.split('/');
      parts.pop(); // å»æ‰æœ€åä¸€çº§
      const parent = parts.length ? parts.join('/') : '.';

      loadFilesFromApi(parent);
    }

    // ç»‘å®šå›é€€æŒ‰é’®
    const fmBackBtn = document.getElementById('fmBackBtn');
    if (fmBackBtn) {
      fmBackBtn.addEventListener('click', () => {
        goUpOneLevel();
      });
    }


    // è®© File Manager é‡Œçš„è¡Œå¯ä»¥ç‚¹å‡»ï¼šç‚¹æ–‡ä»¶å¤¹å°±è¿›å…¥ä¸‹ä¸€å±‚
    document.addEventListener('click', (event) => {
      const table = document.getElementById('fmTable');
      if (!table) return;

      // åªå¤„ç† File Manager é‡Œçš„ç‚¹å‡»
      if (!table.contains(event.target)) return;

      const row = event.target.closest('.fm-row');
      if (!row) return;

      const name = row.dataset.name;
      const isDir = row.dataset.isDir === 'true';

      // header è¡Œæ²¡æœ‰ data-nameï¼Œæˆ–è€…æ˜¯æ–‡ä»¶å°±å…ˆä¸å¤„ç†
      if (!name || !isDir) return;

      // è®¡ç®—æ–°è·¯å¾„ï¼šæ ¹ç›®å½• '.' åŠ å­ç›®å½•ï¼Œæˆ–åœ¨å·²æœ‰è·¯å¾„åé¢è¿½åŠ 
      const newPath = currentPath === '.' ? name : `${currentPath}/${name}`;

      loadFilesFromApi(newPath);
    });


    // è®© File Manager é‡Œçš„è¡Œå¯ä»¥ç‚¹å‡»ï¼šç‚¹æ–‡ä»¶å¤¹å°±è¿›å…¥ä¸‹ä¸€å±‚
    nav.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-target]');
      if (!btn) return;
      const target = btn.getAttribute('data-target');

      // 1. åˆ‡æ¢å·¦ä¾§æŒ‰é’® active çŠ¶æ€
      [...nav.querySelectorAll('button')].forEach(b =>
        b.classList.toggle('active', b === btn)
      );

      // 2. åˆ‡æ¢æ˜¾ç¤º/éšè—è§†å›¾
      Object.entries(views).forEach(([key, el]) => {
        el.hidden = key !== target;
      });

      // 3. è®°å½•å½“å‰è§†å›¾
      document.body.dataset.view = target;

      // 4. åˆ‡æ¢é¡¶éƒ¨æ ‡é¢˜
      const mapping = { 
        anime: 'Anime', 
        movies: 'Movies', 
        photos: 'Photo Library', 
        files: 'File Manager' 
      };
      title.textContent = mapping[target] || 'Home Cloud';

      // 5. ğŸš€ å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿›å…¥ File Managerï¼Œåˆ™åŠ è½½æ ¹ç›®å½•
      if (target === 'files' && !filesLoadedOnce) {
        loadFilesFromApi('.');   // åŠ è½½æ ¹ç›®å½•
        filesLoadedOnce = true;  // é˜²æ­¢é‡å¤åŠ è½½
      }

      // 6. åˆ‡æ¢è§†å›¾æ—¶æ¸…ç©ºæœç´¢å†…å®¹
      if (searchBox) searchBox.value = '';

      // 7.ï¼ˆå¯é€‰ï¼‰åˆ‡åˆ°æŸä¸ªè§†å›¾çš„æ—¶å€™ï¼Œç”¨å®Œæ•´æ•°æ®é‡æ¸²æŸ“ä¸€é
      if (target === 'anime') renderAnime();
      if (target === 'movies') renderMovies();
      if (target === 'photos') renderPhotos();
      if (target === 'files' && currentFileItems.length) {
        renderFiles(currentFileItems);
      }
    });

    // æ–°å»ºæ–‡ä»¶å¤¹
    if (btnNewFolder) {
      btnNewFolder.addEventListener('click', async () => {
        const name = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å¤¹åç§°ï¼š');
        if (!name) return;

        const folderName = name.trim();
        if (!folderName) return;

        const payload = {
          path: currentPath || '.',      // æ ¹ç›®å½•å°±æ˜¯ '.'
          folder_name: folderName,
        };

        try {
          const res = await fetch(`${API_FILES}/mkdir`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            let errMsg = `åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥ï¼š${res.status}`;
            try {
              const errJson = await res.json();
              if (errJson.detail) errMsg = errJson.detail;
            } catch (_) {}
            alert(errMsg);
            return;
          }

          // æˆåŠŸååˆ·æ–°å½“å‰ç›®å½•
          await res.json();
          await loadFilesFromApi(currentPath);
        } catch (err) {
          console.error(err);
          alert('åˆ›å»ºæ–‡ä»¶å¤¹æ—¶å‡ºç°é”™è¯¯ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œæˆ–åç«¯é—®é¢˜ï¼‰');
        }
      });
    }

    // ä¸Šä¼ æ–‡ä»¶
    if (btnUpload && fmUploadInput) {
      // ç‚¹å‡»æŒ‰é’® -> æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
      btnUpload.addEventListener('click', () => {
        fmUploadInput.value = ''; // æ¸…ç©ºä¸Šæ¬¡é€‰æ‹©
        fmUploadInput.click();
      });

      // é€‰å®Œæ–‡ä»¶ -> ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æ–‡ä»¶ä½œä¸º "files" ä¼ ä¸Šå»
      fmUploadInput.addEventListener('change', async () => {
        const files = Array.from(fmUploadInput.files || []);
        if (!files.length) return;

        const formData = new FormData();

        // å’Œåç«¯å¯¹é½ï¼šå­—æ®µåå« "files"
        for (const file of files) {
          formData.append('files', file);
        }

        // è·¯å¾„å­—æ®µå« pathï¼Œæ ¹ç›®å½•ç”¨ "."
        formData.append('path', currentPath || '.');

        try {
          const res = await fetch(`${API_FILES}/upload`, {
            method: 'POST',
            body: formData,
          });

          if (!res.ok) {
            let errMsg = `ä¸Šä¼ å¤±è´¥ï¼š${res.status}`;
            try {
              const errJson = await res.json();
              console.log('upload error json:', errJson);
              if (Array.isArray(errJson.detail)) {
                errMsg = errJson.detail.map(d => `${d.loc?.join('.')}: ${d.msg}`).join('; ');
              } else if (typeof errJson.detail === 'string') {
                errMsg = errJson.detail;
              }
            } catch (_) {}
            alert(`ä¸Šä¼ å¤±è´¥ï¼š${errMsg}`);
          } else {
            await res.json(); // ç”¨ä¸åˆ°å†…å®¹å°±ä¸¢æ‰æ²¡å…³ç³»
          }
        } catch (err) {
          console.error(err);
          alert(`ä¸Šä¼ æ–‡ä»¶æ—¶å‡ºç°é”™è¯¯`);
        }

        // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œï¼Œå†åˆ·æ–°å½“å‰ç›®å½•
        await loadFilesFromApi(currentPath);
      });
    }


    // Initial paint
    window.addEventListener('DOMContentLoaded', () => {
      loadAnimeFromApi();
      loadMoviesFromApi();
      loadPhotosFromApi();  // âœ… ç”¨ NAS çœŸæ•°æ®
    });

    // =========================
    // File Manager å³é”®èœå•é€»è¾‘
    // =========================

    function setMenuItemDisabled(action, disabled) {
      if (!fmMenu) return;
      const li = fmMenu.querySelector(`li[data-action="${action}"]`);
      if (!li) return;
      if (disabled) li.classList.add('disabled');
      else li.classList.remove('disabled');
    }

    function updateContextMenuState() {
      const hasEntry = fmContextTarget && fmContextTarget.type === 'entry';
      const hasClipboard = !!fmClipboard;

      setMenuItemDisabled('open',   !hasEntry);
      setMenuItemDisabled('copy',   !hasEntry);
      setMenuItemDisabled('cut',    !hasEntry);
      setMenuItemDisabled('delete', !hasEntry);
      setMenuItemDisabled('paste',  !hasClipboard);
    }

    function showContextMenu(x, y, targetInfo) {
      if (!fmMenu) return;
      fmContextTarget = targetInfo;
      updateContextMenuState();

      fmMenu.style.display = 'block';
      fmMenu.style.left = x + 'px';
      fmMenu.style.top  = y + 'px';

      // é˜²æ­¢æº¢å‡ºå±å¹•
      const rect = fmMenu.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      if (rect.right > vw) {
        fmMenu.style.left = (vw - rect.width - 8) + 'px';
      }
      if (rect.bottom > vh) {
        fmMenu.style.top = (vh - rect.height - 8) + 'px';
      }
    }

    function hideContextMenu() {
      if (fmMenu) fmMenu.style.display = 'none';
    }

    // åœ¨æ•´ä¸ª File Manager é¢æ¿ä¸Šç›‘å¬å³é”®
    if (fmPanel) {
      fmPanel.addEventListener('contextmenu', (e) => {
        if (fmMenu && fmMenu.contains(e.target)) return;
        e.preventDefault();

        let targetInfo;
        const isInTable = fmTable && fmTable.contains(e.target);
        const row = isInTable ? e.target.closest('.fm-row') : null;

        if (row && row.dataset.name) {
          const name = row.dataset.name;
          const isDir = row.dataset.isDir === 'true';
          const fullPath = currentPath === '.' ? name : `${currentPath}/${name}`;

          targetInfo = {
            type: 'entry',
            name,
            isDir,
            path: fullPath,
          };
        } else {
          targetInfo = {
            type: 'blank',
            path: currentPath || '.',
          };
        }

        showContextMenu(e.clientX, e.clientY, targetInfo);
      });
    }

    // ç‚¹å‡»åˆ«å¤„ / æ»šåŠ¨ / Esc å…³é—­èœå•
    document.addEventListener('click', (e) => {
      if (!fmMenu) return;
      if (!fmMenu.contains(e.target)) hideContextMenu();
    });
    document.addEventListener('scroll', hideContextMenu, true);
    window.addEventListener('resize', hideContextMenu);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideContextMenu();
    });

    // èœå•ç‚¹å‡»åˆ†å‘
    if (fmMenu) {
      fmMenu.addEventListener('click', async (e) => {
        const li = e.target.closest('li[data-action]');
        if (!li || li.classList.contains('disabled')) return;

        const action = li.dataset.action;
        hideContextMenu();

        switch (action) {
          case 'open':
            await handleFmOpen();
            break;
          case 'copy':
            handleFmCopy(false);
            break;
          case 'cut':
            handleFmCopy(true);
            break;
          case 'paste':
            await handleFmPaste();
            break;
          case 'delete':
            await handleFmDelete();
            break;
        }
      });
    }

    // ========= å…·ä½“æ“ä½œ =========

    // Openï¼šæ–‡ä»¶å¤¹è¿›å…¥ï¼›æ–‡ä»¶ç”¨é™æ€åœ°å€åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
    async function handleFmOpen() {
      if (!fmContextTarget || fmContextTarget.type !== 'entry') return;

      const { name, isDir, path } = fmContextTarget;

      if (isDir) {
        const newPath = currentPath === '.' ? name : `${currentPath}/${name}`;
        await loadFilesFromApi(newPath);
      } else {
        // è®¡ç®—ç›¸å¯¹è·¯å¾„
        const relPath = path || (currentPath === '.' ? name : `${currentPath}/${name}`);
        const fileUrl = buildStaticMediaUrl(relPath);

        if (isImageFile(name)) {
          // å›¾ç‰‡ï¼šç”¨å’Œ Photos ä¸€æ ·çš„é®ç½©é¢„è§ˆ
          openPhotoPreview(fileUrl, name);
        } else {
          // å…¶ä»–ç±»å‹ï¼šå…ˆä¿æŒç”¨æµè§ˆå™¨æ‰“å¼€/ä¸‹è½½
          window.open(fileUrl, '_blank');
        }
      }
    }


    // Copy / Cutï¼šå¡«å……å‰ªè´´æ¿
    function handleFmCopy(isCut) {
      if (!fmContextTarget || fmContextTarget.type !== 'entry') return;

      fmClipboard = {
        mode: isCut ? 'cut' : 'copy',
        fromPath: currentPath || '.',
        name: fmContextTarget.name,
        isDir: fmContextTarget.isDir,
      };

      updateContextMenuState();
    }

    // Pasteï¼šè°ƒç”¨åç«¯ /move_copy
    async function handleFmPaste() {
      if (!fmClipboard) return;

      const payload = {
        src_path: fmClipboard.fromPath,
        dst_path: currentPath || '.',
        name: fmClipboard.name,
        is_dir: fmClipboard.isDir,
        mode: fmClipboard.mode,       // 'copy' or 'cut'
      };

      try {
        const res = await fetch(`${API_FILES}/move_copy`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          let msg = `ç²˜è´´å¤±è´¥ï¼š${res.status}`;
          try {
            const data = await res.json();
            if (data.detail) msg = data.detail;
          } catch (_) {}
          alert(msg);
          return;
        }

        if (fmClipboard.mode === 'cut') {
          fmClipboard = null; // å‰ªåˆ‡æˆåŠŸåæ¸…ç©ºå‰ªè´´æ¿
        }

        await loadFilesFromApi(currentPath);
      } catch (err) {
        console.error(err);
        alert('ç²˜è´´æ—¶å‘ç”Ÿé”™è¯¯');
      } finally {
        updateContextMenuState();
      }
    }

    // Deleteï¼šè°ƒç”¨åç«¯ /delete
    async function handleFmDelete() {
      if (!fmContextTarget || fmContextTarget.type !== 'entry') return;

      const { name, isDir } = fmContextTarget;
      const text = isDir
        ? `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${name}" åŠå…¶æ‰€æœ‰å†…å®¹å—ï¼Ÿ`
        : `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${name}" å—ï¼Ÿ`;
      if (!confirm(text)) return;

      const payload = {
        path: currentPath || '.',
        name,
        is_dir: isDir,
      };

      try {
        const res = await fetch(`${API_FILES}/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          let msg = `åˆ é™¤å¤±è´¥ï¼š${res.status}`;
          try {
            const data = await res.json();
            if (data.detail) msg = data.detail;
          } catch (_) {}
          alert(msg);
          return;
        }

        await loadFilesFromApi(currentPath);
      } catch (err) {
        console.error(err);
        alert('åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯');
      }
    }

  </script>
</body>
</html>